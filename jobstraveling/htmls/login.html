<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>로그인</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK (Canvas에서 자동 주입되지만 명시적으로 포함) -->
    <!-- Firestore, Auth 모듈을 사용합니다. -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        setLogLevel('Debug');

        // 전역 변수 설정 (캔버스 환경에서 제공)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;

        /**
         * Streamlit 부모에게 메시지를 전송하는 유틸리티 함수
         * @param {string} type - 이벤트 유형 (예: 'NAVIGATE_TO', 'LOGIN_SUCCESS')
         * @param {object} payload - 전달할 데이터
         */
        function postMessageToParent(type, payload = {}) {
            // console.log("PostMessage:", type, payload);
            window.parent.postMessage({ type, payload }, '*');
        }

        /**
         * 사용자 프로필 데이터를 Firestore에서 가져옵니다.
         * @param {string} uid - Firebase Auth User ID
         * @returns {Promise<object | null>} 사용자 프로필 데이터
         */
        async function fetchUserProfile(uid) {
            if (!db) return null;
            
            // 데이터베이스 보안 규칙에 따른 경로 사용
            const docPath = `/artifacts/${appId}/users/${uid}/userProfile/profile`;
            const userProfileRef = doc(db, docPath);

            try {
                const docSnap = await getDoc(userProfileRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                } else {
                    console.warn("Firestore에 사용자 프로필 데이터가 없습니다.");
                    return { uid: uid, email: auth.currentUser.email || 'N/A' }; // 최소 정보 반환
                }
            } catch (error) {
                console.error("Firestore에서 사용자 프로필을 가져오는 중 오류 발생:", error);
                return null;
            }
        }

        /**
         * 이메일/비밀번호로 로그인 처리를 수행합니다.
         */
        async function handleLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const messageDiv = document.getElementById('message');
            
            messageDiv.textContent = '';
            messageDiv.className = 'text-center p-2 rounded-md';

            if (!email || !password) {
                messageDiv.textContent = '이메일과 비밀번호를 모두 입력해 주세요.';
                messageDiv.classList.add('bg-red-100', 'text-red-700');
                return;
            }

            try {
                // 1. 이메일/비밀번호로 로그인 시도
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // 2. 로그인 성공 후 사용자 프로필 정보 가져오기
                const profileData = await fetchUserProfile(user.uid);

                if (profileData) {
                    messageDiv.textContent = '로그인 성공! 홈 화면으로 이동합니다.';
                    messageDiv.classList.add('bg-green-100', 'text-green-700');

                    // 3. Streamlit으로 사용자 정보와 함께 성공 메시지 전송
                    postMessageToParent('LOGIN_SUCCESS', {
                        userData: profileData
                    });

                } else {
                    // 프로필은 없지만 Auth 로그인은 성공한 경우 (비정상 케이스)
                    messageDiv.textContent = '로그인 성공, 하지만 프로필을 찾을 수 없습니다.';
                    messageDiv.classList.add('bg-orange-100', 'text-orange-700');
                    
                    // 최소 정보만 보내고 홈으로 이동
                     postMessageToParent('LOGIN_SUCCESS', {
                        userData: { uid: user.uid, email: user.email || 'N/A', studentName: '사용자' }
                    });
                }

            } catch (error) {
                console.error("로그인 실패:", error.code, error.message);
                let errorMessage;
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                    case 'auth/invalid-credential':
                        errorMessage = '이메일 또는 비밀번호가 올바르지 않습니다.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = '유효하지 않은 이메일 형식입니다.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = '로그인 시도가 너무 많습니다. 잠시 후 다시 시도해 주세요.';
                        break;
                    default:
                        errorMessage = '로그인 중 오류가 발생했습니다. 잠시 후 다시 시도해 주세요.';
                }
                messageDiv.textContent = errorMessage;
                messageDiv.classList.add('bg-red-100', 'text-red-700');
            }
        }

        /**
         * Firebase를 초기화하고 Custom Token으로 인증합니다.
         */
        async function initializeFirebaseAndAuth() {
             if (firebaseConfig) {
                try {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // Custom Auth Token으로 로그인 시도
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // Custom Token이 없으면 익명 로그인 시도
                        await signInAnonymously(auth);
                    }
                    
                    // 인증 상태 변경 리스너 설정
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            // console.log("Firebase Auth Ready. Current User ID:", userId);
                        } else {
                            userId = null;
                            // console.log("Firebase Auth Ready. No user signed in.");
                        }
                    });

                    // 로그인 버튼 활성화
                    document.getElementById('login-button').disabled = false;
                    document.getElementById('message').textContent = '로그인 준비 완료.';
                    document.getElementById('message').classList.add('bg-blue-100', 'text-blue-700');

                } catch (error) {
                    console.error("Firebase 초기화 또는 인증 오류:", error);
                    document.getElementById('message').textContent = '서비스 초기화에 실패했습니다. (콘솔 확인)';
                    document.getElementById('message').classList.add('bg-red-100', 'text-red-700');
                }
            } else {
                 console.error("Firebase 설정 정보가 없습니다.");
                 document.getElementById('message').textContent = 'Firebase 설정 정보가 누락되었습니다.';
                 document.getElementById('message').classList.add('bg-red-100', 'text-red-700');
            }
        }

        // DOM 로드 후 초기화 및 이벤트 리스너 연결
        document.addEventListener('DOMContentLoaded', () => {
            initializeFirebaseAndAuth();

            // 로그인 버튼 이벤트 리스너
            const loginButton = document.getElementById('login-button');
            if (loginButton) {
                loginButton.addEventListener('click', handleLogin);
            }

            // 회원가입 버튼 이벤트 리스너 (Streamlit 페이지 전환 요청)
            const signupButton = document.getElementById('signup-button');
            if (signupButton) {
                signupButton.addEventListener('click', () => {
                    postMessageToParent('NAVIGATE_TO', { page: 'signup' });
                });
            }
            
             // 엔터 키 입력 시 로그인 시도
             document.getElementById('password').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // 기본 Enter 동작(폼 제출) 방지
                    handleLogin();
                }
            });
        });

    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .login-container {
            max-width: 400px;
            width: 90%;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-top: 5px solid #3b82f6; /* Blue border for design */
        }
        input[type="email"], input[type="password"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input[type="email"]:focus, input[type="password"]:focus {
            border-color: #3b82f6;
            outline: none;
        }
        .btn-primary {
            width: 100%;
            padding: 12px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-primary:active {
            transform: scale(0.99);
        }
        .btn-primary:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }
        .btn-secondary {
            width: 100%;
            padding: 12px;
            background-color: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }
        .message-box {
             min-height: 40px;
             display: flex;
             align-items: center;
             justify-content: center;
             margin-bottom: 15px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="login-container">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Job-Trekking 로그인</h2>
        
        <div id="message" class="message-box text-center p-2 rounded-md bg-gray-100 text-gray-600">
             로그인 시스템 초기화 중...
        </div>

        <form id="login-form">
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">이메일 주소</label>
            <input type="email" id="email" placeholder="school@email.com" required>

            <label for="password" class="block text-sm font-medium text-gray-700 mb-1">비밀번호</label>
            <input type="password" id="password" placeholder="비밀번호 (6자 이상)" required>

            <button type="button" id="login-button" class="btn-primary" disabled>
                로그인
            </button>
        </form>

        <div class="text-center my-4 text-gray-500">
            또는
        </div>

        <button id="signup-button" class="btn-secondary">
            회원가입
        </button>
    </div>

</body>
</html>
