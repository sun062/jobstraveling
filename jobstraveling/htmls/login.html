<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>잡스트레블링 - 로그인</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .input-field { width: 100%; padding: 10px; border: none; border-bottom: 2px solid #ddd; }
        .input-field:focus { outline: none; border-bottom-color: #3b82f6; }
        .login-button { background-color: #2563eb; transition: background-color 0.15s; }
        .login-button:hover { background-color: #1d4ed8; }
    </style>
</head>
<body class="p-4 sm:p-8 flex items-center justify-center min-h-screen">
    <div class="max-w-md w-full mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl space-y-6">
        <header class="text-center pb-4">
            <h1 class="text-3xl font-bold text-gray-800">잡스트레블링 로그인</h1>
            <p class="text-sm text-gray-500 mt-1">로그인 후 다양한 진로 체험 프로그램을 만나보세요.</p>
        </header>

        <form onsubmit="handleLogin(event)" class="space-y-4">
            <div>
                <label for="username" class="block font-medium text-gray-700">아이디</label>
                <input type="text" id="username" placeholder="아이디를 입력하세요" class="input-field" required>
            </div>
            <div>
                <label for="password" class="block font-medium text-gray-700">비밀번호</label>
                <input type="password" id="password" placeholder="비밀번호를 입력하세요" class="input-field" required>
            </div>
            
            <button type="submit" 
                    class="w-full py-3 mt-4 text-lg font-bold text-white login-button rounded-lg shadow-md transform hover:scale-[1.005]">
                로그인
            </button>
        </form>

        <div class="flex justify-center space-x-6 pt-4 text-sm">
            <a href="#" onclick="requestStreamlitRedirect('forgot_password')" 
               class="text-blue-500 hover:underline">비밀번호 찾기</a>
            <a href="#" onclick="requestStreamlitRedirect('signup')" 
               class="text-blue-500 hover:underline">회원가입</a>
        </div>
        
        <p class="text-xs text-gray-400 text-center pt-2">현재 UID: <span id="currentUid">로딩 중</span></p>
    </div>
    
    <!-- 메시지 박스 및 스크립트 -->
    <div id="messageBox" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="messageText" class="text-gray-800 font-medium mb-4">로그인 시도 중...</p>
            <button onclick="continueAction()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">확인</button>
        </div>
    </div>

    <script type="module">
        // Firebase 초기화 및 인증 로직을 위한 공통 JS 코드를 HTML <script> 부분에 추가합니다.
        // 이 코드는 모든 HTML 파일에 복사되어야 합니다.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, setDoc, doc, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db;
        let auth;
        let userId; 
        let appId;
        let isFirebaseReady = false; 
        
        async function initializeFirebase() {
            try {
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                isFirebaseReady = true; 
                console.log("Firebase initialized successfully. User ID:", userId);
                
                if (typeof onPageLoad === 'function') {
                    onPageLoad(); 
                }

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
            }
        }
        
        function getUsersCollectionRef() {
            if (!isFirebaseReady) {
                console.error("Database not initialized.");
                return null;
            }
            // 공용 데이터 경로: /artifacts/{appId}/public/data/users
            const path = `artifacts/${appId}/public/data/users`; 
            return collection(db, path);
        }
        
        function showMessage(text, action = null) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            
            messageText.textContent = text;
            window.nextAction = action; 
            if (messageBox) messageBox.classList.remove('hidden');
        }

        function hideMessage() {
            const messageBox = document.getElementById('messageBox');
            if (messageBox) messageBox.classList.add('hidden');
        }
        
        function continueAction() {
            hideMessage();
            if (typeof window.nextAction === 'function') {
                window.nextAction(); 
                window.nextAction = null; 
            }
        }

        function requestStreamlitRedirect(pageName) {
            parent.postMessage({type: 'NAVIGATE', page: pageName}, '*');
        }

        window.onload = initializeFirebase;
        
        // --- 로그인 화면 전용 JS ---

        function onPageLoad() {
            document.getElementById('currentUid').textContent = userId;
        }

        // 로그인 버튼 클릭 시 실행될 함수
        async function handleLogin(event) {
            event.preventDefault();
            
            if (!isFirebaseReady) {
                showMessage('데이터베이스 연결 중입니다. 잠시 후 다시 시도해 주세요.');
                return;
            }

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            showMessage('로그인 정보를 확인하고 있습니다...');
            
            try {
                const usersRef = getUsersCollectionRef();
                
                // 1. 아이디와 비밀번호가 일치하는 사용자 찾기
                const q = query(usersRef, 
                    where("userId", "==", username),
                    where("password", "==", password)
                );
                
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    showMessage('아이디 또는 비밀번호가 올바르지 않습니다.');
                    return;
                }

                // 2. 로그인 성공
                const userData = querySnapshot.docs[0].data();
                
                showMessage(`${userData.name}님, 환영합니다!`, () => {
                    // Streamlit에 로그인 성공 메시지와 사용자 이름을 전달하여 상태를 home으로 변경
                    parent.postMessage({
                        type: 'LOGIN_SUCCESS', 
                        page: 'home', 
                        username: userData.name
                    }, '*');
                });

            } catch (error) {
                console.error("로그인 중 Firestore 조회 오류:", error);
                showMessage(`로그인 중 오류가 발생했습니다: ${error.message}`);
            }
        }
    </script>
</body>
</html>
