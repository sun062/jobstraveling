<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¡ìŠ¤ë¦¬í¬íŠ¸ ê¸°ë¡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .report-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .form-input, .form-textarea, .form-date {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            margin-bottom: 20px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }
        .form-input:focus, .form-textarea:focus, .form-date:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .submit-btn {
            background-color: #10b981; /* Emerald Green */
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 700;
            transition: background-color 0.2s;
        }
        .submit-btn:hover {
            background-color: #059669;
        }
        /* ë³„ì  ìŠ¤íƒ€ì¼ */
        .rating {
            display: inline-block;
            direction: rtl; 
            unicode-bidi: bidi-override; /* ë³„ ì—­ìˆœìœ¼ë¡œ ë°°ì¹˜ */
        }
        .rating input {
            display: none;
        }
        .rating label {
            color: #ddd;
            font-size: 3rem;
            padding: 0 5px;
            cursor: pointer;
            transition: color 0.2s;
        }
        /* ë³„ì  ìƒ‰ìƒ ë³€ê²½ ë¡œì§ (ì„ íƒëœ ë³„ê³¼ ê·¸ ì•ì˜ ëª¨ë“  ë³„) */
        .rating input:checked ~ label {
            color: #fbbf24; /* Amber 400 */
        }
        .rating label:hover,
        .rating label:hover ~ label {
            color: #f59e0b; /* Amber 500 on hover */
        }
    </style>
</head>
<body class="p-6">

    <div class="report-container">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">ë‚˜ì˜ ì§„ë¡œ ì²´í—˜ ë¦¬í¬íŠ¸</h2>
        
        <!-- ë©”ì‹œì§€ ë° ì„±ê³µ í›„ ë²„íŠ¼ ì˜ì—­ -->
        <div id="message-box" class="hidden p-4 mb-4 rounded-lg text-sm" role="alert"></div>

        <form id="add-report-form">
            
            <!-- 1. ì²´í—˜ ì •ë³´ -->
            <div class="mb-6">
                <label class="block text-lg text-gray-700 font-semibold mb-1">ì²´í—˜ í”„ë¡œê·¸ë¨/ê¸°ê´€ëª…</label>
                <!-- required ì†ì„± ìœ ì§€ -->
                <input type="text" id="programName" class="form-input" required placeholder="ì˜ˆ: êµ¬ê¸€ ì½”ë¦¬ì•„ ê²¬í•™, IT ê°œë°œì ì§ë¬´ ì²´í—˜"/>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <div>
                    <label class="block text-lg text-gray-700 font-semibold mb-1">ì²´í—˜ ì¼ì</label>
                    <input type="date" id="experienceDate" class="form-date" required/>
                </div>
                <div>
                    <label class="block text-lg text-gray-700 font-semibold mb-1">ì§ë¬´/ë¶„ì•¼</label>
                    <input type="text" id="jobField" class="form-input" placeholder="ì˜ˆ: ì†Œí”„íŠ¸ì›¨ì–´ ì—”ì§€ë‹ˆì–´, ë§ˆì¼€íŒ…"/>
                </div>
            </div>

            <!-- 2. ë³„ì  í‰ê°€ -->
            <div class="mb-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                <label class="block text-lg text-gray-700 font-semibold mb-3">ì²´í—˜ ë§Œì¡±ë„ (ë³„ì  5ì  ë§Œì )</label>
                <div class="rating">
                    <!-- ë³„ì  ë¼ë””ì˜¤ ë²„íŠ¼: required ì œê±°í•˜ê³  JSì—ì„œ ìœ íš¨ì„± ê²€ì‚¬ -->
                    <input type="radio" id="star5" name="rating" value="5"/>
                    <label for="star5" title="ë§¤ìš° ë§Œì¡± (5ì )">â˜…</label>
                    <input type="radio" id="star4" name="rating" value="4"/>
                    <label for="star4" title="ë§Œì¡± (4ì )">â˜…</label>
                    <input type="radio" id="star3" name="rating" value="3"/>
                    <label for="star3" title="ë³´í†µ (3ì )">â˜…</label>
                    <input type="radio" id="star2" name="rating" value="2"/>
                    <label for="star2" title="ë¶ˆë§Œì¡± (2ì )">â˜…</label>
                    <input type="radio" id="star1" name="rating" value="1"/>
                    <label for="star1" title="ë§¤ìš° ë¶ˆë§Œì¡± (1ì )">â˜…</label>
                </div>
            </div>

            <!-- 3. ìƒì„¸ ê¸°ë¡ -->
            <div class="mb-6">
                <label class="block text-lg text-gray-700 font-semibold mb-1">ì²´í—˜ ë‚´ìš© ë° ì†Œê°</label>
                <textarea id="reportContent" class="form-textarea" rows="8" required placeholder="ì²´í—˜ì—ì„œ ë°°ìš´ ì , ëŠë‚€ ì , ì¢‹ì•˜ë˜ ì , ì•„ì‰¬ì› ë˜ ì  ë“±ì„ ìƒì„¸í•˜ê²Œ ê¸°ë¡í•´ ì£¼ì„¸ìš”. (ìµœì†Œ 100ì ê¶Œì¥)"></textarea>
            </div>
            
            <button type="submit" id="submit-report-btn" class="submit-btn w-full">ë¦¬í¬íŠ¸ ì €ì¥í•˜ê¸°</button>
        </form>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 1. Streamlit Pythonì—ì„œ ì£¼ì…ëœ ë³€ìˆ˜ ì‚¬ìš©
        const firebaseConfig = JSON.parse('{{FIREBASE_CONFIG}}');
        const initialAuthToken = '{{INITIAL_AUTH_TOKEN}}';
        const appId = '{{APP_ID}}';

        let app, db, auth;
        const messageBox = document.getElementById('message-box');
        const form = document.getElementById('add-report-form');
        const submitBtn = document.getElementById('submit-report-btn');

        // Streamlit í˜ì´ì§€ ì´ë™ í•¨ìˆ˜
        function navigateTo(page) {
             // 'view_reports' ë˜ëŠ” 'home' í˜ì´ì§€ë¡œ ì´ë™í•˜ë„ë¡ Streamlitì— ë©”ì‹œì§€ ì „ë‹¬
             window.parent.postMessage({ type: 'streamlit:setComponentValue', value: page }, '*');
        }

        // 2. ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(text, type) {
            messageBox.textContent = text;
            messageBox.className = `p-4 mb-4 rounded-lg text-sm`;
            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-700', 'block');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-700', 'block');
            } else {
                messageBox.classList.add('bg-blue-100', 'text-blue-700', 'block');
            }
            messageBox.classList.remove('hidden');
        }

        // 3. Firebase ì´ˆê¸°í™” ë° ì¸ì¦
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // ìµëª… ë˜ëŠ” ì»¤ìŠ¤í…€ í† í°ìœ¼ë¡œ ì¸ì¦
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                console.log("Firebase initialized. User ID:", auth.currentUser?.uid);

            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì‹¤íŒ¨:", error);
                showMessage(`ì‹œìŠ¤í…œ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // 4. í¼ ì œì¶œ í•¸ë“¤ëŸ¬
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!db || !auth.currentUser) {
                showMessage('ì¸ì¦ ì˜¤ë¥˜: ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.', 'error');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.textContent = 'ì €ì¥ ì¤‘...';
            messageBox.classList.add('hidden'); // ê¸°ì¡´ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
            
            // ë³„ì  ê°’ ê°€ì ¸ì˜¤ê¸° (í•„ìˆ˜ ê²€ì‚¬)
            const ratingValue = form.querySelector('input[name="rating"]:checked')?.value;
            
            if (!ratingValue) {
                showMessage('ì²´í—˜ ë§Œì¡±ë„(ë³„ì )ë¥¼ ë°˜ë“œì‹œ ì„ íƒí•´ ì£¼ì„¸ìš”.', 'error'); // ëª…í™•í•œ ì˜¤ë¥˜ ë©”ì‹œì§€
                submitBtn.disabled = false;
                submitBtn.textContent = 'ë¦¬í¬íŠ¸ ì €ì¥í•˜ê¸°';
                return;
            }

            // í•„ìˆ˜ ì…ë ¥ í•„ë“œ í™•ì¸ (í”„ë¡œê·¸ë¨ëª…, ì¼ì, ë‚´ìš©)
            if (!document.getElementById('programName').value || 
                !document.getElementById('experienceDate').value || 
                !document.getElementById('reportContent').value) {
                showMessage('ì²´í—˜ í”„ë¡œê·¸ë¨ëª…, ì¼ì, ë‚´ìš© ë“± í•„ìˆ˜ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ë¦¬í¬íŠ¸ ì €ì¥í•˜ê¸°';
                return;
            }

            const userId = auth.currentUser.uid;

            const newReport = {
                userId: userId,
                programName: document.getElementById('programName').value,
                experienceDate: document.getElementById('experienceDate').value,
                jobField: document.getElementById('jobField').value || 'ë¯¸ì •',
                rating: parseInt(ratingValue, 10), // ìˆ«ìë¡œ ì €ì¥
                reportContent: document.getElementById('reportContent').value,
                createdAt: new Date().toISOString(),
            };
            
            // ë°ì´í„°ë² ì´ìŠ¤ ê²½ë¡œ: /artifacts/{appId}/users/{userId}/reports (ê°œì¸ ë°ì´í„°)
            const collectionPath = `/artifacts/${appId}/users/${userId}/reports`;

            try {
                // ìƒˆë¡œìš´ ë¬¸ì„œ ì¶”ê°€
                await addDoc(collection(db, collectionPath), newReport);
                
                // --- ì €ì¥ ì„±ê³µ í›„ ë¡œì§ (ì´ì „ ìš”ì²­ ì‚¬í•­ ë°˜ì˜) ---
                form.style.display = 'none'; // í¼ ìˆ¨ê¸°ê¸°
                submitBtn.disabled = false; 
                
                // ì„±ê³µ ë©”ì‹œì§€ ë° ë²„íŠ¼ í‘œì‹œ
                messageBox.className = 'p-6 mb-4 rounded-xl text-lg bg-green-50 text-green-700 block text-center';
                messageBox.innerHTML = `
                    <p class="font-bold text-2xl mb-4 text-green-600">ì €ì¥ ì™„ë£Œ! ğŸ‰</p>
                    <p class="mb-6 text-gray-600">ë¦¬í¬íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ í™œë™ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
                    <div class="flex flex-col space-y-3">
                        <button onclick="navigateTo('view_reports')" class="w-full py-3 bg-indigo-500 text-white font-semibold rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md">
                            ğŸ“– ë‚˜ì˜ ê¸°ë¡ ë³´ê¸°
                        </button>
                        <button onclick="navigateTo('home')" class="w-full py-3 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition duration-150 shadow-md">
                            ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                `;

            } catch (error) {
                console.error("ë¦¬í¬íŠ¸ ì €ì¥ ì‹¤íŒ¨:", error);
                showMessage(`ë¦¬í¬íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'ë¦¬í¬íŠ¸ ì €ì¥í•˜ê¸°';
            }
        });

        // 5. í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = initializeFirebase;
    </script>
</body>
</html>
