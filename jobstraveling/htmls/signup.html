<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>잡스트레블링 - 회원가입</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
        .input-field { width: 100%; padding: 10px; border: none; border-bottom: 1px solid #ddd; transition: border-bottom-color 0.15s ease-in-out; font-size: 16px; }
        .input-field:focus { outline: none; border-bottom-color: #3b82f6; }
        .input-label { display: block; font-weight: 600; color: #4b5563; margin-bottom: 4px; font-size: 14px; }
        #signupButton:disabled { background-color: #9ca3af; cursor: not-allowed; transform: none; }
    </style>
</head>
<body class="p-4 sm:p-8">
    <div class="max-w-xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl space-y-8">
        <header class="pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800">회원가입</h1>
            <p class="text-sm text-gray-500 mt-1">* 필수정보입력</p>
        </header>

        <form id="signupForm" onsubmit="handleSignup(event)" class="space-y-6">
            <section class="space-y-4 border p-4 rounded-lg bg-blue-50/50">
                <h2 class="text-xl font-bold text-blue-700 mb-4">나의 학교 정보 입력 *</h2>
                
                <div class="flex items-center space-x-6">
                    <span class="input-label !mb-0 w-20">구분 *</span>
                    <div class="flex space-x-4">
                        <span class="px-3 py-1 bg-blue-600 text-white text-sm rounded-full font-semibold">학생</span>
                        <span class="px-3 py-1 bg-gray-200 text-gray-600 text-sm rounded-full">교사</span>
                    </div>
                </div>

                <div>
                    <div class="flex items-end space-x-2">
                        <div class="flex-grow">
                            <label for="school" class="input-label">학교 *</label>
                            <input type="text" id="school" name="school" placeholder="학교를 입력하거나 검색해 주세요." class="input-field border-b-2" required>
                        </div>
                        <button type="button" onclick="showMessage('학교 검색 기능 구현 예정')" class="flex-shrink-0 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">학교 찾기</button>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label for="grade" class="input-label">학년 *</label>
                        <select id="grade" name="grade" class="input-field border-b-2" required>
                            <option value="">선택</option><option value="1">1학년</option><option value="2">2학년</option><option value="3">3학년</option>
                        </select>
                    </div>
                    <div>
                        <label for="classNum" class="input-label">반 *</label>
                        <input type="number" id="classNum" name="classNum" placeholder="반" class="input-field border-b-2" required>
                    </div>
                    <div>
                        <label for="studentNum" class="input-label">번호 *</label>
                        <input type="number" id="studentNum" name="studentNum" placeholder="번호" class="input-field border-b-2" required>
                    </div>
                </div>
            </section>
            
            <section class="space-y-6">
                <div>
                    <label for="name" class="input-label">이름 *</label>
                    <input type="text" id="name" name="name" placeholder="이름을 입력하세요" class="input-field" required>
                </div>

                <div>
                    <label for="userId" class="input-label">아이디 *</label>
                    <div class="flex space-x-2">
                        <input type="text" id="userId" name="userId" placeholder="아이디" class="input-field flex-grow" required>
                        <button type="button" onclick="showMessage('아이디 중복확인 기능 구현 예정')" class="flex-shrink-0 px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition text-sm">중복확인</button>
                    </div>
                </div>

                <div>
                    <label for="email" class="input-label">이메일 *</label>
                    <input type="email" id="email" name="email" placeholder="이메일 주소" class="input-field" required>
                </div>

                <div>
                    <label for="password" class="input-label">비밀번호 *</label>
                    <input type="password" id="password" name="password" placeholder="8자 이상 20자 이하" class="input-field" required onkeyup="checkPasswordMatch()">
                    <p class="text-xs text-gray-500 mt-1">✓ 8자 이상 20자 이하 (대소문자, 숫자, 특수문자 3개 조합 권장)</p>
                </div>

                <div>
                    <label for="passwordConfirm" class="input-label">비밀번호 확인 *</label>
                    <input type="password" id="passwordConfirm" name="passwordConfirm" placeholder="비밀번호 재확인" class="input-field" required onkeyup="checkPasswordMatch()">
                    <p id="passwordMatchMessage" class="text-xs mt-1 h-4"></p>
                </div>
                
                <div>
                    <label for="birthdate" class="input-label">생년월일 *</label>
                    <div class="relative">
                        <input type="date" id="birthdate" name="birthdate" class="input-field pr-10" required>
                        <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                        </span>
                    </div>
                </div>

            </section>
            
            <button type="submit" id="signupButton" class="w-full py-3 mt-8 text-xl font-bold text-white bg-blue-500 hover:bg-blue-600 rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-[1.005] focus:outline-none focus:ring-4 focus:ring-blue-300" disabled>
                가입하기
            </button>
            
            <button type="button" onclick="redirectToLogin()" class="w-full py-3 text-base font-semibold text-gray-600 bg-gray-200 hover:bg-gray-300 rounded-lg transition duration-150 ease-in-out">
                취소 및 돌아가기
            </button>

        </form>

        <!-- 메시지 박스 -->
        <div id="messageBox" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
                <p id="messageText" class="text-gray-800 font-medium mb-4"></p>
                <button onclick="continueAction()" id="messageBoxConfirmButton" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">확인</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase 초기화 및 인증 로직을 위한 공통 JS 코드를 HTML <script> 부분에 추가합니다.
        // 이 코드는 모든 HTML 파일에 복사되어야 합니다.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, setDoc, doc, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db;
        let auth;
        let userId; 
        let appId;
        let isFirebaseReady = false; 
        
        async function initializeFirebase() {
            try {
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                isFirebaseReady = true; 
                console.log("Firebase initialized successfully. User ID:", userId);
                
                if (typeof onPageLoad === 'function') {
                    onPageLoad(); 
                }

            } catch (error) {
                console.error("Firebase initialization or sign-in failed:", error);
            }
        }
        
        function getUsersCollectionRef() {
            if (!isFirebaseReady) {
                console.error("Database not initialized.");
                return null;
            }
            // 공용 데이터 경로: /artifacts/{appId}/public/data/users
            const path = `artifacts/${appId}/public/data/users`; 
            return collection(db, path);
        }
        
        function showMessage(text, action = null) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            
            messageText.textContent = text;
            window.nextAction = action; 
            if (messageBox) messageBox.classList.remove('hidden');
        }

        function hideMessage() {
            const messageBox = document.getElementById('messageBox');
            if (messageBox) messageBox.classList.add('hidden');
        }
        
        function continueAction() {
            hideMessage();
            if (typeof window.nextAction === 'function') {
                window.nextAction(); 
                window.nextAction = null; 
            }
        }

        function requestStreamlitRedirect(pageName) {
            parent.postMessage({type: 'NAVIGATE', page: pageName}, '*');
        }

        window.onload = initializeFirebase;
        
        // --- 회원가입 화면 전용 JS ---

        let isPasswordMatched = false;

        function redirectToLogin() {
             showMessage('로그인 화면으로 돌아갑니다.', () => {
                 requestStreamlitRedirect('login');
             });
        }
        
        function checkPasswordMatch() {
            const password = document.getElementById('password').value;
            const passwordConfirm = document.getElementById('passwordConfirm').value;
            const messageElement = document.getElementById('passwordMatchMessage');
            const signupButton = document.getElementById('signupButton');

            if (passwordConfirm.length === 0) {
                messageElement.textContent = '';
                messageElement.className = 'text-xs mt-1 h-4';
                isPasswordMatched = false;
            } else if (password === passwordConfirm) {
                messageElement.textContent = '비밀번호가 일치합니다.';
                messageElement.className = 'text-xs mt-1 font-semibold text-green-600 h-4';
                isPasswordMatched = true;
            } else {
                messageElement.textContent = '비밀번호가 일치하지 않습니다.';
                messageElement.className = 'text-xs mt-1 font-semibold text-red-600 h-4';
                isPasswordMatched = false;
            }
            
            signupButton.disabled = !isPasswordMatched; 
        }

        // 회원가입 버튼 클릭 시 실행될 함수 (Firestore 연동 구현)
        async function handleSignup(event) {
            event.preventDefault(); 
            
            if (!isPasswordMatched) {
                showMessage('비밀번호 확인이 일치하지 않아 가입할 수 없습니다. 확인 후 다시 시도해 주세요.');
                return;
            }
            
            if (!isFirebaseReady || !userId) {
                showMessage('데이터베이스 연결 중이거나 인증에 실패했습니다. 잠시 후 다시 시도해 주세요.');
                return;
            }
            
            const form = document.getElementById('signupForm');
            const formData = new FormData(form);
            const user_id = formData.get('userId'); 
            const password = formData.get('password'); 
            
            showMessage('회원 정보를 확인하고 있습니다...');
            
            try {
                const usersRef = getUsersCollectionRef();
                
                // 1. 아이디 중복 확인 쿼리
                const q = query(usersRef, where("userId", "==", user_id));
                const querySnapshot = await getDocs(q);
                
                if (!querySnapshot.empty) {
                    showMessage('이미 사용 중인 아이디입니다. 다른 아이디를 사용해 주세요.');
                    return;
                }

                // 2. 새로운 사용자 데이터 객체 생성
                const userUID = doc(usersRef).id; 
                const userData = {
                    userDocId: userUID, 
                    userId: user_id,
                    password: password, 
                    name: formData.get('name'),
                    email: formData.get('email'),
                    birthdate: formData.get('birthdate'),
                    school: formData.get('school'),
                    grade: formData.get('grade'),
                    classNum: formData.get('classNum'),
                    studentNum: formData.get('studentNum'),
                    createdAt: new Date().toISOString()
                };

                // 3. Firestore에 데이터 저장 
                await setDoc(doc(usersRef, userUID), userData);

                showMessage('회원가입이 완료되었습니다! 로그인 화면으로 이동합니다.', () => {
                    requestStreamlitRedirect('login');
                });
                
            } catch (error) {
                console.error("회원가입 중 Firestore 저장 오류:", error);
                showMessage(`회원가입 중 오류가 발생했습니다: ${error.message}`);
            }
        }
        
        function onPageLoad() {
            document.getElementById('signupButton').disabled = true;
        }
    </script>
</body>
</html>
