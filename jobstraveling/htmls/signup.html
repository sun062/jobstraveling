<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íšŒì›ê°€ì…</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 20px;
            background-color: #f4f7f6;
            margin: 0;
            min-height: 100vh;
        }
        .signup-container {
            background: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px;
        }
        h2 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
            font-size: 0.9em;
        }
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        .input-group input:focus {
            border-color: #007bff;
            outline: none;
        }
        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s, opacity 0.3s;
            margin-top: 10px;
        }
        #signup-button:not([disabled]) {
            background-color: #28a745; /* Green for Active */
            color: white;
        }
        #signup-button[disabled] {
            background-color: #ccc; /* Gray for Disabled */
            color: #666;
            cursor: not-allowed;
        }
        #message-box {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #007bff;
            background-color: #e9f7fe;
        }
        .link-back {
            display: block;
            text-align: center;
            margin-top: 20px;
            color: #007bff;
            text-decoration: none;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="signup-container">
        <h2>íšŒì›ê°€ì…</h2>
        <div id="message-box">ì‹œìŠ¤í…œ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>
        
        <div class="input-group">
            <label for="email">ì´ë©”ì¼ (ID)</label>
            <input type="email" id="email" required>
        </div>
        <div class="input-group">
            <label for="password">ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
            <input type="password" id="password" required>
        </div>
        
        <!-- ì¶”ê°€ í•™ìƒ ì •ë³´ í•„ë“œ -->
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        <div class="input-group">
            <label for="schoolName">í•™êµ ì´ë¦„</label>
            <input type="text" id="schoolName" required>
        </div>
        <div class="input-group">
            <label for="classNumber">ë°˜ ë²ˆí˜¸</label>
            <input type="text" id="classNumber" required>
        </div>
        <div class="input-group">
            <label for="studentName">ì´ë¦„</label>
            <input type="text" id="studentName" required>
        </div>
        <div class="input-group">
            <label for="birthDate">ìƒë…„ì›”ì¼</label>
            <input type="date" id="birthDate" required>
        </div>
        
        <button id="signup-button" onclick="signup()" disabled>íšŒì›ê°€ì… ì™„ë£Œ</button>

        <a href="#" class="link-back" onclick="navigate('login'); return false;">&larr; ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/streamlit-component-lib@1.3.0/dist/streamlit-component-lib.js"></script>
    
    <script type="module">
        // Firebase ëª¨ë“ˆ ì„í¬íŠ¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì •
        let app, db, auth;
        let authReady = false;
        
        // DOM ìš”ì†Œ ìºì‹±
        const messageBox = document.getElementById('message-box');
        const signupButton = document.getElementById('signup-button');

        // ë©”ì‹œì§€ í‘œì‹œ ìœ í‹¸ë¦¬í‹°
        function displayMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.style.color = isError ? '#dc3545' : '#007bff';
            messageBox.style.backgroundColor = isError ? '#f8d7da' : '#e9f7fe';
        }

        // í˜ì´ì§€ ì „í™˜ ìœ í‹¸ë¦¬í‹°
        window.navigate = (page) => {
            Streamlit.setComponentValue({ type: 'NAVIGATE_TO', payload: { page: page } });
        };
        
        // Firebase ì´ˆê¸°í™” í•¨ìˆ˜
        async function initFirebase() {
            try {
                displayMessage("ì‹œìŠ¤í…œ ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤. Firebase ì´ˆê¸°í™” ì‹œë„...", false);

                // ì „ì—­ window ê°ì²´ì—ì„œ Streamlitì´ ì£¼ì…í•œ ì„¤ì • ì‚¬ìš©
                const firebaseConfig = window.__firebase_config;
                const appId = window.__app_id || 'default-app-id'; // Fallback

                if (!firebaseConfig || !firebaseConfig.apiKey || !window.__app_id) {
                     throw new Error("Firebase ì„¤ì • ë˜ëŠ” App IDê°€ Streamlitì—ì„œ ì£¼ì…ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // ì´ˆê¸° ì¸ì¦ ìƒíƒœ í™•ì¸ (ìµëª… ë¡œê·¸ì¸ ì‹œë„)
                await signInAnonymously(auth);

                // ì„±ê³µì ìœ¼ë¡œ ì´ˆê¸°í™” ë° ì¸ì¦ ì™„ë£Œ
                authReady = true;
                displayMessage("ì¤€ë¹„ ì™„ë£Œ! íšŒì›ê°€ì… ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.", false);
                signupButton.disabled = false;
                console.log("Firebase ì´ˆê¸°í™” ì„±ê³µ. ë²„íŠ¼ í™œì„±í™”.");

            } catch (error) {
                authReady = false;
                const errorMessage = `Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜: ${error.message}`;
                displayMessage(`ğŸš¨ ì˜¤ë¥˜: ${errorMessage}. ê°œë°œìì—ê²Œ ë¬¸ì˜í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`, true);
                console.error(errorMessage);
            }
        }
        
        // íšŒì›ê°€ì… í•¨ìˆ˜
        window.signup = async () => {
            if (!authReady) {
                displayMessage("ì‹œìŠ¤í…œ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", true);
                return;
            }

            // ì…ë ¥ ê°’ ê°€ì ¸ì˜¤ê¸°
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const schoolName = document.getElementById('schoolName').value;
            const classNumber = document.getElementById('classNumber').value;
            const studentName = document.getElementById('studentName').value;
            const birthDate = document.getElementById('birthDate').value;
            
            if (!email || !password || !schoolName || !classNumber || !studentName || !birthDate) {
                displayMessage("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.", true);
                return;
            }

            if (password.length < 6) {
                displayMessage("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.", true);
                return;
            }

            signupButton.disabled = true;
            displayMessage("íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘...", false);

            try {
                // 1. Firebase Authentication: ì‚¬ìš©ì ìƒì„±
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                const userId = user.uid;
                
                // 2. Firestore: í•™ìƒ í”„ë¡œí•„ ì €ì¥
                const userProfileRef = doc(db, 
                    `artifacts/${window.__app_id}/users/${userId}/userProfile/profile`
                );
                
                await setDoc(userProfileRef, {
                    email: user.email,
                    schoolName: schoolName,
                    classNumber: classNumber,
                    studentName: studentName,
                    birthDate: birthDate,
                    createdAt: new Date().toISOString()
                });
                
                console.log("íšŒì›ê°€ì… ë° Firestore ì €ì¥ ì„±ê³µ", userId);
                displayMessage("íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.", false);
                
                // 3. Streamlitìœ¼ë¡œ ì„±ê³µ ì´ë²¤íŠ¸ ì „ì†¡ ë° í˜ì´ì§€ ì „í™˜
                Streamlit.setComponentValue({ type: 'SIGNUP_SUCCESS', payload: { userId: userId } });
                
            } catch (error) {
                let userMessage = "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                // Firebase Error Codeì— ë”°ë¥¸ ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€
                if (error.code === 'auth/email-already-in-use') {
                    userMessage = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.";
                } else if (error.code === 'auth/weak-password') {
                    userMessage = "ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì·¨ì•½í•©ë‹ˆë‹¤ (6ì ì´ìƒ).";
                }
                
                console.error("íšŒì›ê°€ì… ì˜¤ë¥˜:", error.code, error.message);
                displayMessage(`ğŸš¨ ${userMessage} (${error.code})`, true);
                signupButton.disabled = false; // ë‹¤ì‹œ ì‹œë„ ê°€ëŠ¥í•˜ë„ë¡ ë²„íŠ¼ í™œì„±í™”
            }
        };

        // Streamlit ì»´í¬ë„ŒíŠ¸ ë¡œë“œ ì™„ë£Œ ì‹œ Firebase ì´ˆê¸°í™” ì‹œì‘
        Streamlit.events.addEventListener(Streamlit.events.LOADED, function() {
            initFirebase();
        });
        
        // Streamlit í”„ë ˆì„ ë†’ì´ ì„¤ì •
        Streamlit.setComponentValue({ height: 620 });
    </script>
</body>
</html>
