<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§„ë¡œ íƒìƒ‰ í™ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        setLogLevel('Debug');
        
        let auth;
        let db;
        let userId;
        let userProfile = {};

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const app = initializeApp(window.firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user && user.isAnonymous === false) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = userId;
                        
                        // 1. ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ (íšŒì›ê°€ì… ì‹œ ì…ë ¥ëœ í•™êµ ì •ë³´)
                        await loadUserProfile(userId);

                        // 2. í”„ë¡œê·¸ë¨ ëª©ë¡ ë¡œë“œ (ìƒ˜í”Œ)
                        await loadPrograms();

                    } else {
                        // ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒë˜ì—ˆê±°ë‚˜ ìµëª… ì‚¬ìš©ìì¼ ê²½ìš° ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ê°•ì œ ì´ë™
                        sendToStreamlit('LOGOUT_SUCCESS');
                    }
                });
            } catch (error) {
                console.error("Firebase ì´ˆê¸°í™” ë˜ëŠ” ì¸ì¦ ì˜¤ë¥˜:", error);
                sendToStreamlit('AUTH_ERROR', { message: `Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}` });
            }
        });

        async function loadUserProfile(uid) {
            const docRef = doc(db, "artifacts", window.appId, "users", uid, "profile", "data");
            try {
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    userProfile = docSnap.data();
                    document.getElementById('welcome-message').textContent = 
                        `${userProfile.schoolName} ${userProfile.grade} í•™ìƒ í™˜ì˜í•©ë‹ˆë‹¤!`;
                } else {
                    document.getElementById('welcome-message').textContent = `í™˜ì˜í•©ë‹ˆë‹¤! (í”„ë¡œí•„ ë°ì´í„° ì—†ìŒ)`;
                }
            } catch (error) {
                console.error("ì‚¬ìš©ì í”„ë¡œí•„ ë¡œë“œ ì˜¤ë¥˜:", error);
            }
        }

        async function loadPrograms() {
            const programsContainer = document.getElementById('programs-list');
            programsContainer.innerHTML = '<p class="text-gray-500">ì§„ë¡œ í”„ë¡œê·¸ë¨ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</p>';

            // Firestore ìƒ˜í”Œ ë°ì´í„° ë¡œë“œ (ê³µê°œ ë°ì´í„° ì»¬ë ‰ì…˜ ê²½ë¡œ ì‚¬ìš©)
            // ì‹¤ì œ êµ¬í˜„ ì‹œ 'programs' ì»¬ë ‰ì…˜ì— ë°ì´í„°ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
            const programsColRef = collection(db, "artifacts", window.appId, "public", "data", "programs");
            
            // ğŸš¨ ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì— í•™êµ ì •ë³´ë‚˜ ê´€ì‹¬ì‚¬ì— ê¸°ë°˜í•œ ì¿¼ë¦¬ê°€ ì¶”ê°€ë©ë‹ˆë‹¤.
            try {
                const q = query(programsColRef);
                const querySnapshot = await getDocs(q);
                
                let programHtml = '';
                if (querySnapshot.empty) {
                    programHtml = '<p class="text-gray-500 p-4 bg-yellow-50 rounded-lg">í˜„ì¬ ë“±ë¡ëœ ì§„ë¡œ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                } else {
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        programHtml += `
                            <div class="p-4 border-b hover:bg-gray-50 transition duration-150">
                                <h4 class="font-semibold text-blue-600">${data.title || 'ì œëª© ì—†ìŒ'}</h4>
                                <p class="text-sm text-gray-500">${data.location || 'ìœ„ì¹˜ ì •ë³´ ì—†ìŒ'} | ${data.date || 'ë‚ ì§œ ë¯¸ì •'}</p>
                                <button class="mt-2 text-xs text-indigo-500 hover:text-indigo-700">ìì„¸íˆ ë³´ê¸° &gt;</button>
                            </div>
                        `;
                    });
                }
                programsContainer.innerHTML = programHtml;

            } catch (error) {
                console.error("í”„ë¡œê·¸ë¨ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:", error);
                programsContainer.innerHTML = `<p class="text-red-500 p-4 bg-red-100 rounded-lg">í”„ë¡œê·¸ë¨ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}</p>`;
            }
        }

        window.logout = async () => {
            try {
                await signOut(auth);
                // Streamlitì— ë¡œê·¸ì•„ì›ƒ ì„±ê³µ ì´ë²¤íŠ¸ ì „ì†¡
                sendToStreamlit('LOGOUT_SUCCESS');
            } catch (error) {
                console.error("ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:", error);
                // alert ëŒ€ì‹  ë©”ì‹œì§€ ë°•ìŠ¤ ì‚¬ìš© í•„ìš”
                sendToStreamlit('AUTH_ERROR', { message: `ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ${error.message}` });
            }
        };
    </script>
</head>
<body class="bg-gray-100 min-h-screen p-8" style="font-family: 'Inter', sans-serif;">
    <div class="w-full max-w-6xl mx-auto bg-white p-10 rounded-xl shadow-2xl space-y-8">
        <!-- í—¤ë” ë° ë¡œê·¸ì•„ì›ƒ -->
        <div class="flex justify-between items-center pb-4 border-b">
            <div>
                <h1 class="text-3xl font-extrabold text-gray-900">ğŸ’¼ ì¡ìŠ¤íŠ¸ë ˆë¸”ë§ (Job-Trekking)</h1>
                <p id="welcome-message" class="text-xl text-gray-600 mt-1">ë¡œê·¸ì¸ ì •ë³´ í™•ì¸ ì¤‘...</p>
                <p class="text-xs text-gray-400 mt-1">ì‚¬ìš©ì ID: <span id="user-id-display">N/A</span></p>
            </div>
            <button onclick="logout()" 
                    class="px-5 py-2 border border-transparent text-sm font-medium rounded-lg text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 shadow-md">
                ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>

        <!-- ì§€ë„ ë° ëª©ë¡ ì„¹ì…˜ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 1. ì§€ë„ (Placeholder) -->
            <div class="lg:col-span-2 bg-gray-200 h-96 rounded-xl shadow-inner flex items-center justify-center border-4 border-gray-300">
                <div class="text-center text-gray-600 p-4">
                    <div class="text-4xl mb-2">ğŸ—ºï¸</div>
                    <p class="font-bold">ì§€ë„ ê¸°ë°˜ ì§„ë¡œ íƒìƒ‰ ì˜ì—­</p>
                    <p class="text-sm">ì‹¤ì œ êµ¬í˜„ ì‹œ ì´ ìœ„ì¹˜ì— ì§€ë„(ì˜ˆ: Kakao/Naver Map)ê°€ í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- 2. í”„ë¡œê·¸ë¨ ëª©ë¡ -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-xl border border-gray-100">
                <h3 class="text-2xl font-bold text-blue-700 mb-4 border-b pb-2">ë‚˜ì—ê²Œ ë§ëŠ” ì¶”ì²œ í”„ë¡œê·¸ë¨</h3>
                <div id="programs-list" class="space-y-2 max-h-[300px] overflow-y-auto">
                    <!-- í”„ë¡œê·¸ë¨ ëª©ë¡ì´ ì—¬ê¸°ì— ë¡œë“œë©ë‹ˆë‹¤. -->
                </div>
                <button class="w-full mt-4 py-2 bg-blue-100 text-blue-600 font-medium rounded-lg hover:bg-blue-200 transition duration-150">
                    ì „ì²´ í”„ë¡œê·¸ë¨ ë” ë³´ê¸°
                </button>
            </div>
        </div>

        <!-- ì •ë³´ ì œê³µ ì„¹ì…˜ (ì¶”ê°€ ê¸°ëŠ¥) -->
        <div class="pt-4 border-t">
            <h3 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“¢ ì¡ìŠ¤íŠ¸ë ˆë¸”ë§ ì¶”ì²œ ê°€ì´ë“œ</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="p-4 bg-indigo-50 rounded-lg shadow-md border border-indigo-200">
                    <h4 class="font-bold text-indigo-700">í•™êµ ê¸°ë°˜ ë§ì¶¤ ì§„ë¡œ</h4>
                    <p class="text-sm text-indigo-600">ë“±ë¡ëœ í•™êµ/í•™ë…„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ê°€ê¹Œìš´ ì§€ì—­ì˜ ì§„ë¡œ í™œë™ì„ ì¶”ì²œí•©ë‹ˆë‹¤.</p>
                </div>
                <div class="p-4 bg-yellow-50 rounded-lg shadow-md border border-yellow-200">
                    <h4 class="font-bold text-yellow-700">ë©˜í† ë§/íƒë°© ê¸°ë¡</h4>
                    <p class="text-sm text-yellow-600">ì§„ë¡œ íƒë°© í›„ê¸° ë° ë©˜í† ë§ ê¸°ë¡ì„ ì €ì¥í•˜ê³  ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
                <div class="p-4 bg-green-50 rounded-lg shadow-md border border-green-200">
                    <h4 class="font-bold text-green-700">ê³µì§€ ë° ì•Œë¦¼</h4>
                    <p class="text-sm text-green-600">ìƒˆë¡œìš´ í”„ë¡œê·¸ë¨ ë“±ë¡, ì‹ ì²­ ë§ˆê° ì•Œë¦¼ ë“±ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
